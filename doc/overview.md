# 📌 BoxShell 概要

## 1. 実装コマンド一覧・機能概要・実装方針

| コマンド                          | 機能概要                     | 実装方針                                                                                                                          |
| ----------------------------- | ------------------------ | ----------------------------------------------------------------------------------------------------------------------------- |
| **pwd**                           | 仮想的な Box 上のカレントディレクトリを表示 | 仮想カレント（フォルダID・パス）をそのまま表示                                                                                                      |
| **cd \<dir>**                     | Box 上の仮想カレントを移動          | フォルダ名→ID解決し内部状態を更新。移動先の子要素をキャッシュ（補完用）                                                                                         |
| **ls**                            | Box 上のカレント配下を一覧          | Box API（フォルダ配下一覧）で取得し表示・キャッシュ                                                                                                 |
| **cat \<file>**                   | Box ファイル内容を表示            | Box API（ファイルダウンロード）→一時読み出し→標準出力                                                                                               |
| **fd \<name>**                    | 名前検索（Box、カレント配下）         | Search API（name フィルタ）。必要に応じてルートをカレント配下に限定（フィルタ）                                                                               |
| **rg \<pattern>**                 | 内容検索（Box、カレント配下）         | Search API（全文検索）が一致を返す場合はそれを使用。足りない場合は候補をダウンロードしてローカル grep フォールバック                                                            |
| **mkdir \<name>**                 | Box に空フォルダ作成             | 現在の Box 仮想カレント直下に新規フォルダを作成（重名時の処理は API の既定に準拠）                                                                                |
| **download \[options] \<path>**   | Box → ローカル保存             | 保存先: `XDG_DATA_HOME/boxshell/<file_id>/<timestamp>/<filename>`（Windows は `LOCALAPPDATA` フォールバック）。ファイル名は変更しない。 `-l`でダウンロードするローカル仮想パスを指定。指定したフォルダにダウンロードする。     |
| **upload \[options] \<path>**     | ローカル→Box アップロード          | `-l` 指定でローカル仮想カレント基準のパスを使用。ファイルが未存在なら新規作成、存在すれば**新バージョン**として更新。引数が**ディレクトリ**なら Box に同名フォルダを作成し**再帰アップロード**（フォルダ階層・バージョン規約に従う） |
| **open \<file>**                  | download したファイルを開く       | `<file_id>/<timestamp>` フォルダの**最新**を既定アプリで開く                                                                     |
| **lock \<file> \[duration]**      | Box ファイルのロック取得／自分のロック一覧  | duration は単位付き：`Ns/Nm/Nh/Nd`。**デフォルトは m（分）**。`-1` で無期限。引数なしは自分が保持中のロック一覧。実装はファイルの `lock` 属性（`expires_at` を計算して設定）             |
| **gc**                            | ローカル download キャッシュ掃除    | `XDG_DATA_HOME/boxshell`（Windows は `LOCALAPPDATA` フォールバック）配下で**最終更新 24h 超**を削除                                                |
| **!ls**                           | **ローカル**仮想カレントの一覧        | OS には `chdir` せず、保持している**ローカル仮想カレント**配下を列挙                                                                                    |
| **!cd \<dir>**                    | **ローカル**仮想カレントを移動        | 文字通りのパス解決（相対/絶対）。移動先の子要素をキャッシュ（補完用）                                                                                           |
| **!open \<path>**                 | 指定した**ローカル**ファイルを開く      | ローカル仮想カレント基準で解決→既定アプリで開く                                                                                                      |

> 補足：**ブランドカラーのプロンプト**は、Box 仮想カレントが「他組織配下」と判定できるときに ANSI カラーで表示（判定ロジックは `org_`/`/orgs/` 等の規約に合わせて実装）。

---

## 2. 認証・トークン管理（OAuth2）

* **クライアント ID / Secret**：ユーザーごとに払い出し、**環境変数**で取得

  * `BOX_CLIENT_ID`, `BOX_CLIENT_SECRET`
* **OAuth2 フロー**：初回はブラウザで認可→コード交換→`access_token`/`refresh_token` 取得。以降は自動リフレッシュ
* **トークン保存場所（Windows）**

  1. `XDG_DATA_HOME` があれば：`%XDG_DATA_HOME%/boxshell/tokens.json`
  2. なければ：`%LOCALAPPDATA%\\boxshell\\tokens.json`
* **スコープ**：必要な最小限（files.read/write, search, etc.）を付与

---

## 3. 重要ポリシー

* **Box API を優先**。API で不足する箇所（例：厳密な配下限定検索／内容検索の細部）はローカルフォールバックで補完
* **仮想カレント**（Box／ローカルとも）を管理し、**OS の実ディレクトリは変更しない**
* **補完**：Box/ローカル双方の仮想カレント配下をキャッシュして TAB 補完
* **download 命名規約**：フォルダは `<file_id>/<timestamp>`、中身は**元ファイル名**
* **upload のバージョン管理**：同名ファイルが存在すれば**新バージョン**として更新（Box のバージョニングに準拠）

---

## 4. Go ディレクトリ構成

```
boxshell/
├── cmd/
│   └── boxshell/              # main: REPL 起動・初期化
├── internal/
│   ├── shell/                 # 入力ループ、プロンプト、補完、コマンドディスパッチ
│   ├── auth/                  # OAuth2、トークン保存（XDG_DATA_HOME→LOCALAPPDATA）
│   ├── boxapi/                # Box API クライアント（認証、フォルダ/ファイル/検索/ロック等）
│   ├── commands/              # 個別コマンド実装（pwd, cd, ls, cat, fd, rg, download, upload, open, lock, gc, mkdir, !系）
│   ├── storage/               # ローカル保存/パス規約、gc、open（ローカル/キャッシュ）
│   ├── localfs/               # ローカル仮想カレント＆!系操作（!ls, !cd, !open）
│   └── util/                  # 文字色、パス解決、時間/単位パーサ（s/m/h/d）
├── go.mod
└── README.md
```

---

## 5. 実装ステップ

1. **認証基盤**：OAuth2、トークン保存（XDG\_DATA\_HOME→LOCALAPPDATA）
2. **仮想カレント**：Box／ローカルの二系統を管理（プロンプトのブランドカラー含む）
3. **補完基盤**：Box/ローカルの子要素キャッシュと TAB 補完
4. **基本 Box コマンド**：pwd, cd, ls, cat, download, open, mkdir
5. **検索系**：fd（名前）、rg（内容：API＋フォールバック）
6. **アップロード**：`upload` 実装（`-l`、ディレクトリ再帰、バージョン更新）
7. **ローカル操作**：`!ls`, `!cd`, `!open`
8. **ロック**：`lock`（単位 s/m/h/d、デフォルト m、-1 無期限、一覧表示）
9. **メンテ**：`gc`、ログ、エラーハンドリング
10. **テスト**：単体/E2E（Box サンドボックス）、大容量・階層深度・競合ロックの検証

---

## 6. オプション仕様（実装時の細目）

* **`upload -l <path>` の解釈**

  * `<path>` がファイル：カレント（Box）にアップロード（存在時は新バージョン）
  * `<path>` がディレクトリ：Box に同名フォルダを作成し、**再帰的に**全ファイルをアップロード
* **`upload <name>`（`-l` なし）**

  * 省略可だが、指定時は **download キャッシュ**（`XDG_DATA_HOME/boxshell`）から `<name>` に一致する**最新**を解決してアップロード（利便性向上）
* **`lock`**

  * `lock file`（デフォルト分単位）／`lock file 90s`／`lock file 2h`／`lock file -1`
  * 引数なし：自分のロック一覧
* **`mkdir`**

  * 重名時の動作は Box API 仕様に準拠（同名フォルダがある場合の衝突ハンドリングを実装）

---

